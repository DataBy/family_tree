<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Ink+Free&display=swap');

    .inkfree { font-family: 'Ink Free', cursive; }

    /* Estilo base: para cuadros pequeños */
    .glassy {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    /* Estilo reforzado: para paneles grandes */
    .glassy-strong {
      background: rgba(255, 255, 255, 0.08); /* un poquito más claro */
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.25);
      border-radius: 20px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4),
                  inset 0 0 15px rgba(255, 255, 255, 0.05); /* un glow interno */
    }

    .hover-zoom:hover {
      transform: scale(1.12);
      transition: transform 0.2s ease;
    }

    body {
      background: linear-gradient(135deg, #0B3037, #134E5E);
    }

    .material-icons { color: white; }
  </style>
</head>
<body class="flex justify-center items-center min-h-[100dvh] w-full overflow-hidden">

  <!-- Contenedor principal (fluido, sin altura fija para adaptarse en vertical y horizontal) -->
  <div class="flex w-full max-w-[1920px] h-[min(1080px,100dvh)]">

    <!-- Sidebar -->
    <aside class="h-full flex flex-col justify-between w-[240px] md:w-[270px] xl:w-[300px]
                   pt-[clamp(16px,3vh,36px)] pb-[clamp(28px,4vh,53px)]">
      <!-- Superior -->
      <div class="flex flex-col items-start ml-6 md:ml-12 xl:ml-[72px]">
        <!-- Logo -->
        <img src="../static/images/logo.png" alt="Logo"
             class="object-contain
                    w-[180px] md:w-[220px] xl:w-[250px]
                    h-[clamp(120px,18vh,195px)]
                    mb-[clamp(24px,3.6vh,47px)]" />

        <!-- Botones con separación de 33px borde a borde (no se tocan, solo responsividad de contenedor) -->
        <nav class="flex flex-col items-start">
          <!-- Botón Inicio -->
          <a href="{{ url_for('home') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">home</span> Inicio
          </a>
          
          <!-- Botón Personas -->
          <a href="{{ url_for('personas') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">person</span> Personas
          </a>

          <!-- Botón Árbol -->
          <a href="{{ url_for('tree') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">account_tree</span> Árbol
          </a>

          <!-- Botón Buscar -->
          <a href="{{ url_for('search') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">search</span> Buscar
          </a>

          <!-- Botón Historial -->
          <a href="{{ url_for('history') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">history</span> Historial
          </a>
        </nav>
      </div>

      <!-- Cuadro de fecha (alineado al fondo del sidebar; sin mt ni mb) -->
      <div class="glassy text-white
                  w-[200px] md:w-[230px] xl:w-[250px]
                  h-[clamp(210px,25vh,281px)]
                  ml-6 md:ml-12 xl:ml-[72px]
                  mt-auto
                  flex flex-col items-start
                  px-3 md:px-4 pt-[clamp(14px,2.2vh,24px)] pb-[clamp(14px,2.2vh,24px)]
                  rounded-[12px] xl:rounded-[15px]">
        <div class="flex items-center mb-[clamp(24px,3.6vh,53px)]">
          <span class="material-icons text-[clamp(28px,3.4vh,40px)] text-[#7C95FF]">calendar_today</span>
          <p id="reloj-dia" class="text-[clamp(20px,2.6vh,30px)] ml-[clamp(14px,2.4vh,30px)]">17</p>
        </div>
        <div class="flex items-center mb-[clamp(24px,3.6vh,53px)]">
          <span class="material-icons text-[clamp(28px,3.4vh,40px)] text-[#9CCC65]">schedule</span>
          <p id="reloj-mes" class="text-[clamp(20px,2.6vh,30px)] ml-[clamp(14px,2.4vh,30px)]">Agosto</p>
        </div>
        <div class="flex items-center">
          <span class="material-icons text-[clamp(28px,3.4vh,40px)] text-[#FACF43]">wb_sunny</span>
          <p id="reloj-anio" class="text-[clamp(20px,2.6vh,30px)] ml-[clamp(14px,2.4vh,30px)]">2025</p>
        </div>
      </div>
      </aside>

      <script>
        async function actualizarReloj() {
          try {
            const resp = await fetch("/api/time");
            const data = await resp.json();

            document.getElementById("reloj-dia").textContent = data.dia;
            document.getElementById("reloj-mes").textContent = data.mes;
            document.getElementById("reloj-anio").textContent = data.anio;
          } catch (e) {
            console.error("Error al actualizar reloj:", e);
          }
        }

        // Actualizar cada 2 segundos
        setInterval(actualizarReloj, 2000);
        actualizarReloj();
      </script>

    <!-- Contenido principal -->
    <main class="flex-1 min-w-0 flex flex-col p-6 pl-8 md:pl-12 xl:pl-[72px] min-h-0">

      <!-- Barra superior -->
      <div class="flex justify-end items-center mb-6 gap-4 w-full max-w-[1200px] md:max-w-[1400px] xl:max-w-[1500px] mx-auto shrink-0 min-w-0">
        <!-- FAMILIA: botón + dropdown (responsivo en alto/tipografía como el ejemplo) -->
        <div x-data="{ open: false }" class="relative w-full sm:w-[360px] md:w-[460px] xl:w-[529px] mr-0 xl:mr-[50px] min-w-0">
          <!-- Botón principal -->
          <div @click="open = !open"
               class="w-full h-[clamp(46px,5.6vh,60px)]
                      bg-[#01C38E] flex items-center justify-between
                      px-3 md:px-4 rounded-[12px] xl:rounded-[15px]
                      text-white text-[clamp(18px,2.6vh,28px)]
                      shadow-md cursor-pointer">
            <div class="flex items-center gap-2 md:gap-3">
              <span class="material-icons text-[clamp(24px,3.2vh,35px)]">groups</span>
              <span>Familia: {{ familia_activa or ' ' }}</span>
            </div>
            <span class="material-icons text-[clamp(20px,2.6vh,30px)]">expand_more</span>
          </div>

          <!-- Dropdown -->
          <div x-show="open" x-transition
               @click.outside="open = false"
               class="absolute mt-2 w-full bg-white rounded-[12px] xl:rounded-[15px] shadow-lg p-3 md:p-4 z-50">
            <!-- Crear familia -->
            <form method="POST" action="{{ url_for('crear_familia') }}" class="flex gap-2">
              <input type="text" name="nombre_familia" required
                     placeholder="Nombre de la familia"
                     class="flex-1 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#01C38E]" />
              <button type="submit"
                      class="px-3 md:px-4 py-2 bg-[#01C38E] text-white rounded-lg hover:bg-[#037153]">
                Añadir
              </button>
            </form>

            <!-- Lista/selector de familias -->
            <div class="mt-3 md:mt-4">
              {% if familias %}
                <ul class="space-y-2">
                  {% for fam in familias %}
                    <li class="flex items-center justify-between py-2 px-3 rounded-lg
                               {% if fam == familia_activa %} bg-emerald-50 {% else %} bg-gray-50 {% endif %}">
                      <div class="flex items-center gap-2">
                        <span class="material-icons text-[clamp(18px,2.6vh,22px)]
                                    {% if fam == familia_activa %} text-[#01C38E] {% else %} text-gray-500 {% endif %}">
                          groups
                        </span>
                        <span class="text-gray-800 font-medium">{{ fam }}</span>
                        {% if fam == familia_activa %}
                          <span class="ml-2 text-xs text-[#01C38E] font-semibold">(Activa)</span>
                        {% endif %}
                      </div>

                      <!-- Switch para activar -->
                      <form method="POST" action="{{ url_for('seleccionar_familia') }}" class="m-0">
                        <input type="hidden" name="nombre_familia" value="{{ fam }}">
                        <label class="relative inline-block w-10 md:w-12 h-5 md:h-6 align-middle">
                          <input type="checkbox" class="sr-only peer"
                                 onchange="this.form.submit()"
                                 {% if fam == familia_activa %} checked {% endif %}>
                          <span class="absolute inset-0 bg-gray-300 rounded-full transition peer-checked:bg-[#01C38E]"></span>
                          <span class="absolute left-1 top-1 w-3.5 h-3.5 md:w-4 md:h-4 bg-white rounded-full transition-transform
                                       peer-checked:translate-x-5 md:peer-checked:translate-x-6"></span>
                        </label>
                      </form>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-gray-500 text-sm px-1">Aún no hay familias.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- AlpineJS -->
        <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

        <!-- Iconos configuración (altura/tamaño responsivo como el ejemplo) -->
        <div class="w-[220px] md:w-[260px] xl:w-[309px]
                    h-[clamp(46px,5.6vh,60px)]
                    flex items-center justify-around glassy
                    rounded-[12px] xl:rounded-[15px]">
          <span class="material-icons text-[clamp(28px,3.4vh,40px)] hover-zoom">refresh</span>
          <a href="{{ url_for('love') }}" class="cursor-pointer">
            <span class="material-icons text-[clamp(28px,3.4vh,40px)] hover-zoom">favorite</span>
          </a>
          <span class="material-icons text-[clamp(28px,3.4vh,40px)] hover-zoom">settings</span>
          <span class="material-icons text-[clamp(28px,3.4vh,40px)] hover-zoom">logout</span>
        </div>
      </div>

      <!-- Contenedor central (RESPONSIVE en ambas dimensiones, sin cortes) -->
      <div class="glassy-strong rounded-[15px] flex flex-col mx-auto shadow-lg
                  w-full max-w-[1100px] md:max-w-[1350px] xl:max-w-[1500px]
                  flex-1 min-h-0 p-6 md:p-8 overflow-visible">

        <!-- Encabezado -->
        <div class="w-full max-w-[1400px] min-w-0 px-0 md:px-4 mx-auto">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <span class="material-icons text-[34px] text-pink-300">favorite</span>
              <h2 class="text-2xl font-semibold text-white">Unir Parejas</h2>
            </div>
            <div id="banner" class="hidden px-4 py-2 rounded-lg text-sm"></div>
          </div>

          <!-- Buscadores (columna en pantallas angostas; 2 columnas en md+) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 min-w-0">
            <!-- Persona A -->
            <div class="glassy rounded-[15px] p-2 text-white min-w-0">
              <div class="flex items-center gap-3 mb-3">
                <span class="material-icons text-[24px] text-[#01C38E]">person_search</span>
                <h3 class="text-lg font-medium">Persona A</h3>
              </div>
              <div class="relative">
                <input id="input-a" type="text" placeholder="Buscar nombre y apellidos…"
                       class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300 focus:outline-none" />
                <ul id="sug-a" class="absolute z-10 left-0 right-0 mt-1 bg-white rounded-lg shadow-lg text-gray-800 hidden max-h-56 overflow-auto"></ul>
              </div>
              <div id="card-a" class="mt-4 glassy rounded-[12px] p-4 text-sm">
                <div class="text-white/70">Sin selección.</div>
              </div>
            </div>

            <!-- Persona B -->
            <div class="glassy rounded-[15px] p-2 text-white min-w-0">
              <div class="flex items-center gap-3 mb-3">
                <span class="material-icons text-[24px] text-[#01C38E]">person_search</span>
                <h3 class="text-lg font-medium">Persona B</h3>
              </div>
              <div class="relative">
                <input id="input-b" type="text" placeholder="Buscar nombre y apellidos…"
                       class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300 focus:outline-none" />
                <ul id="sug-b" class="absolute z-10 left-0 right-0 mt-1 bg-white rounded-lg shadow-lg text-gray-800 hidden max-h-56 overflow-auto"></ul>
              </div>
              <div id="card-b" class="mt-4 glassy rounded-[12px] p-4 text-sm">
                <div class="text-white/70">Sin selección.</div>
              </div>
            </div>
          </div>

          <!-- Panel de validación -->
          <div class="glassy rounded-[15px] p-2 text-white min-w-0">
            <div class="flex items-center justify-between flex-wrap gap-3">
              <div class="flex items-center gap-3">
                <span class="material-icons text-[24px] text-[#9CCC65]">fact_check</span>
                <h3 class="text-lg font-medium">Validación de Compatibilidad</h3>
              </div>
              <div class="flex gap-3">
                <button id="btn-validar"
                        class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 hover:bg-[#01C38E] transition">
                  Validar
                </button>
                <button id="btn-unir" disabled
                        class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 disabled:opacity-40 hover:bg-[#01C38E] transition">
                  Unir Pareja
                </button>
                <button id="btn-reset"
                        class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 hover:bg-white/20 transition">
                  Limpiar
                </button>
              </div>
            </div>

            <div id="val-res"
                class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 min-w-0 text-sm">
            </div>

          </div>
        </div>
      </div>

      <script>
        // Utilidades
        const $ = (q) => document.querySelector(q);
        const banner   = $("#banner");
        const inputA   = $("#input-a"), inputB = $("#input-b");
        const sugA     = $("#sug-a"),   sugB   = $("#sug-b");
        const cardA    = $("#card-a"),  cardB  = $("#card-b");
        const btnValidar = $("#btn-validar");
        const btnUnir    = $("#btn-unir");
        const btnReset   = $("#btn-reset");
        const valRes     = $("#val-res");

        let selA = null, selB = null; // nombres completos seleccionados

        function showBanner(type, text) {
          banner.classList.remove("hidden");
          banner.textContent = text;
          banner.className = "";
          banner.classList.add("px-4","py-2","rounded-lg","text-sm");
          if (type === "ok") {
            banner.classList.add("bg-emerald-500/20","border","border-emerald-400","text-emerald-200");
          } else if (type === "warn") {
            banner.classList.add("bg-yellow-500/20","border","border-yellow-400","text-yellow-200");
          } else {
            banner.classList.add("bg-red-500/20","border","border-red-400","text-red-200");
          }
        }
        function hideBanner(){ banner.classList.add("hidden"); }

        async function postLove(payload) {
          const res = await fetch("/love", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || ("HTTP " + res.status));
          return data;
        }

        function renderSug(ul, list, onPick) {
          if (!list || !list.length) { ul.classList.add("hidden"); ul.innerHTML = ""; return; }
          ul.innerHTML = "";
          list.forEach(it => {
            const li = document.createElement("li");
            li.className = "px-3 py-2 hover:bg-emerald-50 cursor-pointer";
            li.textContent = it.nombre_completo;
            li.onclick = () => { onPick(it.nombre_completo); ul.classList.add("hidden"); };
            ul.appendChild(li);
          });
          ul.classList.remove("hidden");
        }

        function chips(list) {
          return (list || []).map(t => `<span class="text-xs px-2 py-0.5 rounded bg-white/10 border border-white/20 mr-1">${t}</span>`).join("");
        }

        function renderCard(el, p) {
          if (!p) { el.innerHTML = '<div class="text-white/70">Sin selección.</div>'; return; }
          const vivo = p.fecha_defuncion ? false : true;
          el.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-base font-semibold">${p.nombre_completo || (p.nombre+' '+p.apellidos)}</div>
                <div class="text-white/80 text-sm">Edad: ${p.edad ?? '—'} • Estado: ${p.estado_civil || '—'}</div>
                <div class="mt-2"><span class="text-white/70 text-xs">Afinidades:</span> ${chips(p.afinidades || [])}</div>
              </div>
              <div class="text-sm ${vivo ? 'text-emerald-300' : 'text-red-300'}">${vivo ? 'Vivo' : 'Fallecido'}</div>
            </div>
          `;
        }

        async function pickPerson(slot, name) {
          try {
            const p = await postLove({ mode: "persona", nombre: name });
            if (slot === "A") { selA = p.nombre_completo; renderCard(cardA, p); }
            else { selB = p.nombre_completo; renderCard(cardB, p); }
            hideBanner();
            btnUnir.disabled = true;
            valRes.innerHTML = "";
          } catch (e) {
            showBanner("err", "No se pudo obtener la persona.");
          }
        }

        function debounce(fn, ms=250) {
          let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
        }

        async function doSearch(targetUl, q, onPick) {
          if (!q || q.trim().length < 2) { targetUl.classList.add("hidden"); return; }
          try {
            const data = await postLove({ mode: "search", q });
            renderSug(targetUl, data.items || [], onPick);
          } catch { /* ignore */ }
        }

        // eventos búsqueda
        inputA.addEventListener("input", debounce(() => doSearch(sugA, inputA.value, (name)=>{ inputA.value=name; pickPerson("A",name); }), 220));
        inputB.addEventListener("input", debounce(() => doSearch(sugB, inputB.value, (name)=>{ inputB.value=name; pickPerson("B",name); }), 220));
        inputA.addEventListener("focus", () => inputA.dispatchEvent(new Event("input")));
        inputB.addEventListener("focus", () => inputB.dispatchEvent(new Event("input")));
        document.addEventListener("click", (e)=>{
          if(!sugA.contains(e.target) && e.target!==inputA) sugA.classList.add("hidden");
          if(!sugB.contains(e.target) && e.target!==inputB) sugB.classList.add("hidden");
        });

        function ruleBadge(ok, text, extra="") {
          const icon = ok ? "check_circle" : "cancel";
          const color = ok ? "text-emerald-300" : "text-red-300";
          return `
            <div class="glassy rounded-[12px] p-4">
              <div class="flex items-center gap-2 mb-1">
                <span class="material-icons ${color}">${icon}</span>
                <div class="font-medium">${text}</div>
              </div>
              ${extra ? `<div class="text-white/70 text-sm">${extra}</div>` : ""}
            </div>
          `;
        }

        btnValidar.addEventListener("click", async ()=> {
          if (!selA || !selB) { showBanner("warn","Seleccioná ambas personas."); return; }
          try {
            const res = await postLove({ mode: "validar", a: selA, b: selB });
            const r = res.rules || {};
            const extras = r.afinidad_detalle ? `Afinidad: ${r.afinidad_detalle}` : "";
            const genet  = r.genetica_detalle ? `Genética: ${r.genetica_detalle}` : "";
            valRes.innerHTML = `
              ${ruleBadge(r.mayores_edad,    "Mayores de 18 años")}
              ${ruleBadge(r.disponibles,     "Disponibilidad (no casados/unidos)")}
              ${ruleBadge(r.brecha_edad_ok,  "Diferencia de edad ≤ 15 años")}
              ${ruleBadge(r.afinidad_ok,     "Afinidad emocional (≥ 2 coincidencias y ≥ 70%)", extras)}
              ${ruleBadge(r.genetica_ok,     "Compatibilidad genética", genet)}
            `;
            if (res.ok) {
              showBanner("ok", "Compatibilidad suficiente. Podés unir la pareja.");
              btnUnir.disabled = false;
            } else {
              showBanner("err", (res.reasons && res.reasons.length) ? "No cumplen: " + res.reasons.join("; ") : "No cumplen las reglas.");
              btnUnir.disabled = true;
            }
          } catch (e) {
            showBanner("err", "Error al validar.");
          }
        });

        btnUnir.addEventListener("click", async ()=> {
          if (!selA || !selB) { showBanner("warn","Seleccioná ambas personas."); return; }
          try {
            const res = await postLove({ mode: "unir", a: selA, b: selB });
            if (res.ok) {
              showBanner("ok", "Pareja unida correctamente.");
              await pickPerson("A", selA);
              await pickPerson("B", selB);
              btnUnir.disabled = true;
            } else {
              showBanner("err", (res.reasons && res.reasons.length) ? "No se pudo unir: " + res.reasons.join("; ") : (res.message || "No se pudo unir"));
            }
          } catch (e) {
            showBanner("err", "Error al unir.");
          }
        });

        btnReset.addEventListener("click", ()=>{
          selA = selB = null;
          inputA.value = inputB.value = "";
          cardA.innerHTML = '<div class="text-white/70">Sin selección.</div>';
          cardB.innerHTML = '<div class="text-white/70">Sin selección.</div>';
          valRes.innerHTML = "";
          btnUnir.disabled = true;
          hideBanner();
        });
      </script>
    </main>
  </div>
</body>
</html>
