<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Family Tree</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Ink+Free&display=swap');

    .inkfree { font-family: 'Ink Free', cursive; }

    /* Estilo base: para cuadros pequeños */
    .glassy {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    /* Estilo reforzado: para paneles grandes */
    .glassy-strong {
      background: rgba(255, 255, 255, 0.08); /* un poquito más claro */
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.25);
      border-radius: 20px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4),
                  inset 0 0 15px rgba(255, 255, 255, 0.05); /* un glow interno */
    }

    .hover-zoom:hover {
      transform: scale(1.12);
      transition: transform 0.2s ease;
    }

    body {
      background: linear-gradient(135deg, #0B3037, #134E5E);
    }

    .material-icons { color: white; }
  </style>

  <!-- Hace que el mensaje de persona agregada desaparezca luego de 3 segundos (si existiera) -->
  <script>
    setTimeout(() => {
      const msg = document.getElementById('toast-msg');
      if (msg) msg.remove();
    }, 3000);
  </script>
</head>
<body class="flex justify-center items-center min-h-[100dvh] w-full overflow-hidden">

  <!-- Contenedor principal: ahora fluido (no fijo 1920x1080) -->
  <div class="flex w-full max-w-[1920px] h-[min(1080px,100dvh)] min-w-0">

    <!-- Sidebar -->
    <aside class="h-full flex flex-col justify-between w-[240px] md:w-[270px] xl:w-[300px]
                   pt-[clamp(16px,3vh,36px)] pb-[clamp(28px,4vh,53px)]">

      <!-- Superior -->
      <div class="flex flex-col items-start ml-6 md:ml-12 xl:ml-[72px]">
        <!-- Logo -->
        <img src="../static/images/logo.png" alt="Logo"
             class="object-contain
                    w-[180px] md:w-[220px] xl:w-[250px]
                    h-[clamp(120px,18vh,195px)]
                    mb-[clamp(24px,3.6vh,47px)]">

        <!-- Botones con separación de 33px borde a borde (NO toco estilos de los botones) -->
        <nav class="flex flex-col items-start">
          <a href="{{ url_for('home') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">home</span> Inicio
          </a>
          <a href="{{ url_for('personas') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">person</span> Personas
          </a>
          <a href="{{ url_for('tree') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">account_tree</span> Árbol
          </a>
          <a href="{{ url_for('search') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">search</span> Buscar
          </a>
          <a href="{{ url_for('history') }}"
             class="w-[200px] md:w-[230px] xl:w-[250px]
                    h-[clamp(46px,5.6vh,60px)]
                    mb-[clamp(18px,3vh,33px)]
                    bg-[#01C38E] text-white
                    text-[clamp(18px,2.6vh,30px)]
                    flex items-center gap-x-2 md:gap-x-3 px-3 md:px-4
                    rounded-[12px] md:rounded-[14px] xl:rounded-[15px]
                    hover:bg-[#037153] transition">
            <span class="material-icons text-[clamp(24px,3.2vh,35px)]">history</span> Historial
          </a>
        </nav>
      </div>

      <!-- Cuadro de fecha -->
      <!-- Cuadro de fecha (alineado al fondo del sidebar; sin mt ni mb) -->
      <div class="glassy text-white
                  w-[200px] md:w-[230px] xl:w-[250px]
                  h-[clamp(210px,25vh,281px)]
                  ml-6 md:ml-12 xl:ml-[72px]
                  mt-auto
                  flex flex-col items-start
                  px-3 md:px-4 pt-[clamp(14px,2.2vh,24px)] pb-[clamp(14px,2.2vh,24px)]
                  rounded-[12px] xl:rounded-[15px]">
        <div class="flex items-center mb-[clamp(24px,3.6vh,53px)]">
          <span class="material-icons text-[clamp(28px,3.4vh,40px)] text-[#7C95FF]">calendar_today</span>
          <p id="reloj-dia" class="text-[clamp(20px,2.6vh,30px)] ml-[clamp(14px,2.4vh,30px)]">17</p>
        </div>
        <div class="flex items-center mb-[clamp(24px,3.6vh,53px)]">
          <span class="material-icons text-[clamp(28px,3.4vh,40px)] text-[#9CCC65]">schedule</span>
          <p id="reloj-mes" class="text-[clamp(20px,2.6vh,30px)] ml-[clamp(14px,2.4vh,30px)]">Agosto</p>
        </div>
        <div class="flex items-center">
          <span class="material-icons text-[clamp(28px,3.4vh,40px)] text-[#FACF43]">wb_sunny</span>
          <p id="reloj-anio" class="text-[clamp(20px,2.6vh,30px)] ml-[clamp(14px,2.4vh,30px)]">2025</p>
        </div>
      </div>
      </aside>

      <script>
        async function actualizarReloj() {
          try {
            const resp = await fetch("/api/time");
            const data = await resp.json();

            document.getElementById("reloj-dia").textContent = data.dia;
            document.getElementById("reloj-mes").textContent = data.mes;
            document.getElementById("reloj-anio").textContent = data.anio;
          } catch (e) {
            console.error("Error al actualizar reloj:", e);
          }
        }

        // Actualizar cada 2 segundos
        setInterval(actualizarReloj, 2000);
        actualizarReloj();
      </script>

    <!-- Contenido principal -->
    <main class="flex-1 min-w-0 flex flex-col p-6 pl-[72px] min-h-0">

      <!-- Barra superior -->
      <div class="flex justify-end items-center mb-6 gap-4 w-full max-w-[1500px] mx-auto shrink-0 min-w-0">

        <!-- FAMILIA: botón + dropdown (no modificado) -->
        <div x-data="{ open: false }" class="relative w-full sm:w-[360px] md:w-[460px] xl:w-[529px] mr-0 xl:mr-[50px] min-w-0">
          <div @click="open = !open"
               class="w-full h-[clamp(46px,5.6vh,60px)]
                      bg-[#01C38E] flex items-center justify-between
                      px-3 md:px-4 rounded-[12px] xl:rounded-[15px]
                      text-white text-[clamp(18px,2.6vh,28px)]
                      shadow-md cursor-pointer">
            <div class="flex items-center gap-2 md:gap-3">
              <span class="material-icons text-[clamp(24px,3.2vh,35px)]">groups</span>
              <span>Familia: {{ familia_activa or ' ' }}</span>
            </div>
            <span class="material-icons text-[clamp(20px,2.6vh,30px)]">expand_more</span>
          </div>

          <!-- Dropdown -->
          <div x-show="open" x-transition
               @click.outside="open = false"
               class="absolute mt-2 w-full bg-white rounded-[12px] xl:rounded-[15px] shadow-lg 
                      p-3 md:p-4 z-50 max-h-[60dvh] overflow-y-auto">
            <form method="POST" action="{{ url_for('crear_familia') }}" class="flex gap-2">
              <input type="text" name="nombre_familia" required
                     placeholder="Nombre de la familia"
                     class="flex-1 p-2 rounded-lg border border-gray-300 
                            focus:outline-none focus:ring-2 focus:ring-[#01C38E]" />
              <button type="submit"
                      class="px-3 md:px-4 py-2 bg-[#01C38E] text-white rounded-lg hover:bg-[#037153]">
                Añadir
              </button>
            </form>
            <div class="mt-3 md:mt-4">
              {% if familias %}
                <ul class="space-y-2">
                  {% for fam in familias %}
                    <li class="flex items-center justify-between py-2 px-3 rounded-lg
                               {% if fam == familia_activa %} bg-emerald-50 {% else %} bg-gray-50 {% endif %}">
                      <div class="flex items-center gap-2">
                        <span class="material-icons text-[clamp(18px,2.6vh,22px)]
                                    {% if fam == familia_activa %} text-[#01C38E] {% else %} text-gray-500 {% endif %}">
                          groups
                        </span>
                        <span class="text-gray-800 font-medium">{{ fam }}</span>
                        {% if fam == familia_activa %}
                          <span class="ml-2 text-xs text-[#01C38E] font-semibold">(Activa)</span>
                        {% endif %}
                      </div>
                      <form method="POST" action="{{ url_for('seleccionar_familia') }}" class="m-0">
                        <input type="hidden" name="nombre_familia" value="{{ fam }}">
                        <label class="relative inline-block w-10 md:w-12 h-5 md:h-6 align-middle">
                          <input type="checkbox" class="sr-only peer"
                                 onchange="this.form.submit()"
                                 {% if fam == familia_activa %} checked {% endif %}>
                          <span class="absolute inset-0 bg-gray-300 rounded-full transition peer-checked:bg-[#01C38E]"></span>
                          <span class="absolute left-1 top-1 w-3.5 h-3.5 md:w-4 md:h-4 bg-white rounded-full 
                                       transition-transform peer-checked:translate-x-6"></span>
                        </label>
                      </form>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-gray-500 text-sm px-1">Aún no hay familias.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- AlpineJS -->
        <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

        <!-- Iconos configuración -->
        <div class="w-[220px] md:w-[260px] xl:w-[309px]
                    h-[clamp(46px,5.6vh,60px)]
                    flex items-center justify-around glassy
                    rounded-[12px] xl:rounded-[15px]">

          <span class="material-icons text-[clamp(28px,3.4vh,40px)] hover-zoom"
          style="cursor:pointer"
          onclick="location.reload()">refresh</span>

          <a href="{{ url_for('love') }}" class="cursor-pointer">
            <span class="material-icons text-[clamp(28px,3.4vh,40px)] hover-zoom">favorite</span>
          </a>
          <!-- <span class="material-icons text-[clamp(28px,3.4vh,40px)] hover-zoom">settings</span> -->

          <span class="material-icons text-[clamp(28px,3.4vh,40px)] hover-zoom"
          style="cursor:pointer"
          onclick="window.close()">logout</span>
          
        </div>

      </div>

      <!-- Contenedor central (Historial) RESPONSIVE -->
      <div class="w-full max-w-[1500px] flex-1 min-h-0 glassy-strong rounded-[15px] mx-auto shadow-lg p-6 flex flex-col">
        <h2 class="text-white text-2xl font-semibold mb-4">Buscar Personas</h2>

        <!-- Área de resultados (chat/consulta) -->
        <div id="history-panel" class="glassy rounded-[15px] p-6 text-white flex-1 min-h-0 overflow-y-auto">
          <!-- Estado inicial -->
          <div id="history-empty" class="text-gray-300">
            Usá el cuadro de búsqueda para consultar una persona y ver su historial cronológico (nacimiento, unión en pareja, hijos, viudez, fallecimiento).
          </div>

          <!-- Resultado dinámico -->
          <div id="history-result" class="hidden">
            <!-- Header de persona -->
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-3">
                <span class="material-icons text-[34px] text-[#01C38E]">badge</span>
                <div>
                  <h3 id="person-name" class="text-xl font-semibold"></h3>
                  <p id="person-meta" class="text-sm text-gray-300"></p>
                </div>
              </div>
              <div id="person-tags" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Línea del tiempo -->
            <div class="glassy rounded-[15px] p-5">
              <h4 class="text-lg font-medium mb-4">Línea del tiempo</h4>
              <ol id="timeline" class="relative border-l-2 border-white/20 pl-6 space-y-5">
                <!-- Items dinámicos -->
              </ol>
            </div>
          </div>
        </div>

        <!-- Buscador (debajo o arriba: como prefieras; aquí debajo para que el panel crezca a full) -->
        <form id="history-search" class="glassy rounded-[15px] px-4 py-3 flex items-center gap-3 mt-4 w-full">
          <span class="material-icons text-[28px] text-white">search</span>
          <input
            id="history-input"
            type="text"
            placeholder="Buscar persona por nombre y apellidos…"
            class="flex-1 bg-transparent focus:outline-none text-white text-lg placeholder-gray-300"
            autocomplete="off"
          />
          <button
            type="submit"
            class="px-4 py-2 rounded-[10px] bg-white/10 border border-white/20 text-white hover:bg-[#01C38E] hover:border-[#01C38E] transition"
          >
            Buscar
          </button>
        </form>
      </div>

      <script>
        // Utilidades UI
        const $ = (q) => document.querySelector(q);
        const panelEmpty = $("#history-empty");
        const panelResult = $("#history-result");
        const personName = $("#person-name");
        const personMeta = $("#person-meta");
        const personTags = $("#person-tags");
        const timeline = $("#timeline");

        // Mapa de íconos y etiquetas por tipo de evento
        const EVENT_META = {
          nacimiento:   { label: "Nació",                 icon: "cake" },
          union_pareja: { label: "Unión de pareja",       icon: "favorite" },
          tuvo_hijo:    { label: "Nacimiento de hijo/a",  icon: "child_care" },
          enviudo:      { label: "Enviudó",               icon: "link_off" },
          fallecimiento:{ label: "Falleció",              icon: "local_florist" },
        };

        // Render chips de resumen
        function renderTags(events) {
          personTags.innerHTML = "";
          const counts = events.reduce((acc, e) => {
            acc[e.tipo] = (acc[e.tipo] || 0) + 1;
            return acc;
          }, {});
          Object.entries(counts).forEach(([tipo, n]) => {
            const meta = EVENT_META[tipo] || { label: tipo, icon: "event" };
            const tag = document.createElement("span");
            tag.className = "inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white/10 border border-white/20 text-sm";
            tag.innerHTML = `<span class="material-icons text-[18px]">${meta.icon}</span>${meta.label}: ${n}`;
            personTags.appendChild(tag);
          });
        }

        // Render línea de tiempo
        function renderTimeline(events) {
          // Ordena por año ascendente y luego por tipo
          events.sort((a, b) => {
            const ax = parseInt(a.anio || 0, 10), bx = parseInt(b.anio || 0, 10);
            if (ax !== bx) return ax - bx;
            return (a.tipo || "").localeCompare(b.tipo || "");
          });

          timeline.innerHTML = "";
          events.forEach((ev) => {
            const meta = EVENT_META[ev.tipo] || { label: ev.tipo || "Evento", icon: "event" };
            const item = document.createElement("li");
            item.className = "relative pl-8";
            item.innerHTML = `
              <span class="absolute -left-[8px] top-1.5 w-4 h-4 rounded-full bg-[#01C38E] border-2 border-white"></span>
              <div class="flex items-start justify-between gap-4">
                <div class="flex items-center gap-3">
                  <span class="material-icons text-[22px] text-[#01C38E]">${meta.icon}</span>
                  <div>
                    <div class="text-base font-medium">${meta.label}</div>
                    ${ev.detalle ? `<div class="text-sm text-gray-300">${ev.detalle}</div>` : ""}
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-sm text-white/80 bg-white/10 border border-white/20 rounded-md px-2 py-0.5">${ev.anio || "—"}</span>
                </div>
              </div>
            `;
            timeline.appendChild(item);
          });
        }

        // Rellena la UI con los datos de una persona
        function renderPersonHistory(payload) {
          const { persona = {}, eventos = [] } = payload || {};
          const nombreCompleto = persona.nombre_completo || "—";
          const genero = persona.genero || "";
          const estado = persona.estado_civil || "";

          personName.textContent = nombreCompleto;
          personMeta.textContent = [genero, estado].filter(Boolean).join(" • ");

          renderTags(eventos);
          renderTimeline(eventos);

          panelEmpty.classList.add("hidden");
          panelResult.classList.remove("hidden");
        }

        // DEMO de respaldo si la API aún no existe
        function demoPayload(nombre) {
          const now = new Date().getFullYear();
          return {
            persona: {
              nombre_completo: nombre,
              genero: "—",
              estado_civil: "",
            },
            eventos: [
              { tipo: "nacimiento",   anio: now - 30,  detalle: "" },
              { tipo: "union_pareja", anio: now - 6,   detalle: "Con su pareja actual" },
              { tipo: "tuvo_hijo",    anio: now - 4,   detalle: "Primer hijo/a" },
              { tipo: "tuvo_hijo",    anio: now - 1,   detalle: "Segundo hijo/a" },
            ],
          };
        }

        // Buscar en backend
        async function fetchHistory(nombre) {
          try {
            const res = await fetch(`/api/history?nombre=${encodeURIComponent(nombre)}`);
            if (!res.ok) throw new Error("HTTP " + res.status);
            const data = await res.json();
            if (!data || (!data.persona && !data.eventos)) throw new Error("payload inválido");
            return data;
          } catch (e) {
            console.warn("Usando DEMO (sin API aún):", e);
            return demoPayload(nombre);
          }
        }

        // Submit del buscador
        document.getElementById("history-search").addEventListener("submit", async (e) => {
          e.preventDefault();
          const q = (document.getElementById("history-input").value || "").trim();
          if (!q) return;

          // Limpia y muestra estado
          panelResult.classList.add("hidden");
          panelEmpty.classList.remove("hidden");
          panelEmpty.textContent = "Buscando…";

          // Traer datos y renderizar
          const payload = await fetchHistory(q);
          renderPersonHistory(payload);
        });
      </script>

    </main>
  </div>
</body>
</html>
