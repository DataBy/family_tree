<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Family Tree</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Ink+Free&display=swap');

    .inkfree { font-family: 'Ink Free', cursive; }

    /* Estilo base: para cuadros pequeños */
    .glassy {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    /* Estilo reforzado: para paneles grandes */
    .glassy-strong {
    background: rgba(255, 255, 255, 0.08); /* un poquito más claro */
    backdrop-filter: blur(20px);
    border: 2px solid rgba(255, 255, 255, 0.25);
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4),
                inset 0 0 15px rgba(255, 255, 255, 0.05); /* un glow interno */
    }

    .hover-zoom:hover {
      transform: scale(1.12);
      transition: transform 0.2s ease;
    }

    body {
      background: linear-gradient(135deg, #0B3037, #134E5E);
    }

    .material-icons { color: white; }
  </style>
</head>
<body class="flex justify-center items-center h-screen w-screen overflow-hidden">

  <!-- Contenedor principal -->
  <div class="w-[1920px] h-[1080px] flex">

    <!-- Sidebar -->
    <aside class="w-[300px] h-full flex flex-col justify-between py-9">

      <!-- Superior -->
      <div class="flex flex-col items-start ml-[72px]">
        <!-- Logo -->
        <img src="../static/images/logo.png" alt="Logo" class="w-[250px] h-[195px] mb-[47px] object-contain">

        <!-- Botones con separación de 33px borde a borde -->
        <nav class="flex flex-col items-start">
          <!-- Botón Inicio -->
            <a href="{{ url_for('home') }}"
            class="w-[250px] h-[60px] mb-[33px] bg-[#01C38E] text-white text-[30px] 
                        flex items-center gap-x-3 px-4 rounded-[15px] hover:bg-[#037153] transition">
            <span class="material-icons text-[35px]">home</span> Inicio
            </a>
          
          <!-- Botón Personas (a) -->
            <a href="{{ url_for('personas') }}"
            class="w-[250px] h-[60px] mb-[33px] bg-[#01C38E] text-white text-[30px] 
                        flex items-center gap-x-3 px-4 rounded-[15px] hover:bg-[#037153] transition">
            <span class="material-icons text-[35px]">person</span> Personas
            </a>

          <!-- Botón Arbol -->
            <a href="{{ url_for('tree') }}"
            class="w-[250px] h-[60px] mb-[33px] bg-[#01C38E] text-white text-[30px] 
                        flex items-center gap-x-3 px-4 rounded-[15px] hover:bg-[#037153] transition">
            <span class="material-icons text-[35px]">account_tree</span> Árbol
            </a>

          <!-- Botón Buscar -->
            <a href="{{ url_for('search') }}"
            class="w-[250px] h-[60px] mb-[33px] bg-[#01C38E] text-white text-[30px] 
                        flex items-center gap-x-3 px-4 rounded-[15px] hover:bg-[#037153] transition">
            <span class="material-icons text-[35px]">search</span> Buscar
            </a>

          <!-- Botón Historial -->
            <a href="{{ url_for('history') }}"
            class="w-[250px] h-[60px] mb-[33px] bg-[#01C38E] text-white text-[30px] 
                        flex items-center gap-x-3 px-4 rounded-[15px] hover:bg-[#037153] transition">
            <span class="material-icons text-[35px]">history</span> Historial
            </a>
        </nav>
      </div>

    <!-- Cuadro de fecha (alineado y con spacing correcto) -->
        <div class="glassy w-[250px] h-[281px] mt-[0px] mb-[53px] ml-[72px] flex flex-col items-start px-4 pt-6 pb-6 rounded-[15px] text-white">
            <div class="flex items-center mb-[53px]">
                <span class="material-icons text-[40px] text-[#7C95FF]">calendar_today</span>
                <p class="text-[30px] ml-[30px]">17</p>
            </div>
            <div class="flex items-center mb-[53px]">
                <span class="material-icons text-[40px] text-[#9CCC65]">schedule</span>
                <p class="text-[30px] ml-[30px]">Agosto</p>
            </div>
            <div class="flex items-center">
                <span class="material-icons text-[40px] text-[#FACF43]">wb_sunny</span>
                <p class="text-[30px] ml-[30px]">2025</p>
            </div>
        </div>
    </aside>

    <!-- Contenido principal -->
    <main class="flex-1 flex flex-col p-6 pl-[72px]">

      <!-- Barra superior -->
      <div class="flex justify-end items-center mb-6 gap-4 w-[1500px] mx-auto">



        <!-- FAMILIA: botón + dropdown -->
        <div x-data="{ open: false }" class="relative w-[529px] mr-[50px]">
          <!-- Botón principal (muestra la familia activa) -->
          <div @click="open = !open"
              class="w-full h-[60px] bg-[#01C38E] flex items-center justify-between px-4 rounded-[15px] text-white text-[28px] shadow-md cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="material-icons text-[35px]">groups</span>
              <span>Familia: {{ familia_activa or ' ' }}</span>
            </div>
            <span class="material-icons text-[30px]">expand_more</span>
          </div>

          <!-- Dropdown -->
          <div x-show="open" x-transition
              @click.outside="open = false"
              class="absolute mt-2 w-full bg-white rounded-[15px] shadow-lg p-4 z-50">

            <!-- Crear familia -->
            <form method="POST" action="{{ url_for('crear_familia') }}" class="flex gap-2">
              <input type="text" name="nombre_familia" required
                    placeholder="Nombre de la familia"
                    class="flex-1 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#01C38E]" />
              <button type="submit"
                      class="px-4 py-2 bg-[#01C38E] text-white rounded-lg hover:bg-[#037153]">
                Añadir
              </button>
            </form>

            <!-- Lista/selector de familias -->
            <div class="mt-4">
              {% if familias %}
                <ul class="space-y-2">
                  {% for fam in familias %}
                    <li class="flex items-center justify-between py-2 px-3 rounded-lg
                              {% if fam == familia_activa %} bg-emerald-50 {% else %} bg-gray-50 {% endif %}">
                      <div class="flex items-center gap-2">
                        <span class="material-icons text-[22px]
                                    {% if fam == familia_activa %} text-[#01C38E] {% else %} text-gray-500 {% endif %}">
                          groups
                        </span>
                        <span class="text-gray-800 font-medium">{{ fam }}</span>
                        {% if fam == familia_activa %}
                          <span class="ml-2 text-xs text-[#01C38E] font-semibold">(Activa)</span>
                        {% endif %}
                      </div>

                      <!-- Switch para activar -->
                      <form method="POST" action="{{ url_for('seleccionar_familia') }}" class="m-0">
                        <input type="hidden" name="nombre_familia" value="{{ fam }}">
                        <label class="relative inline-block w-12 h-6 align-middle">
                          <input type="checkbox" class="sr-only peer"
                                onchange="this.form.submit()"
                                {% if fam == familia_activa %} checked {% endif %}>
                          <span class="absolute inset-0 bg-gray-300 rounded-full transition
                                      peer-checked:bg-[#01C38E]"></span>
                          <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform
                                      peer-checked:translate-x-6"></span>
                        </label>
                      </form>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-gray-500 text-sm px-1">Aún no hay familias.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- AlpineJS (si no lo tenés ya en la página) -->
        <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
        <!-- Iconos configuración -->
        <div class="w-[309px] h-[60px] flex items-center justify-around glassy rounded-[15px]">
          <span class="material-icons text-[40px] hover-zoom">refresh</span>
          <span class="material-icons text-[40px] hover-zoom">notifications</span>
          <span class="material-icons text-[40px] hover-zoom">settings</span>
          <span class="material-icons text-[40px] hover-zoom">logout</span>
        </div>
      </div>




      <!-- Contenedor central -->
      
        <div class="w-[1500px] h-[917px] glassy-strong rounded-[15px] flex flex-col mx-auto shadow-lg p-8">

            <!-- Encabezado -->
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-white text-2xl font-semibold">Historial y Línea del Tiempo</h2>
            </div>

            <!-- Buscador -->
            <form id="history-search" class="glassy rounded-[15px] px-4 py-3 flex items-center gap-3 mb-6 w-full">
                <span class="material-icons text-[28px] text-white">search</span>
                <input
                id="history-input"
                type="text"
                placeholder="Buscar persona por nombre y apellidos…"
                class="flex-1 bg-transparent focus:outline-none text-white text-lg placeholder-gray-300"
                autocomplete="off"
                />
                <button
                type="submit"
                class="px-4 py-2 rounded-[10px] bg-white/10 border border-white/20 text-white hover:bg-[#01C38E] hover:border-[#01C38E] transition"
                >
                Buscar
                </button>
            </form>

            <!-- Panel de resultados -->
            <div id="history-panel" class="glassy rounded-[15px] p-6 text-white flex-1 overflow-y-auto">
                <!-- Estado inicial -->
                <div id="history-empty" class="text-gray-300">
                Usá el cuadro de búsqueda para consultar una persona y ver su historial cronológico (nacimiento, unión en pareja, hijos, viudez, fallecimiento).
                </div>

                <!-- Resultado (se muestra dinámicamente) -->
                <div id="history-result" class="hidden">
                <!-- Header de persona -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                    <span class="material-icons text-[34px] text-[#01C38E]">badge</span>
                    <div>
                        <h3 id="person-name" class="text-xl font-semibold"></h3>
                        <p id="person-meta" class="text-sm text-gray-300"></p>
                    </div>
                    </div>
                    <div id="person-tags" class="flex flex-wrap gap-2"></div>
                </div>

                <!-- Línea del tiempo -->
                <div class="glassy rounded-[15px] p-5">
                    <h4 class="text-lg font-medium mb-4">Línea del tiempo</h4>
                    <ol id="timeline" class="relative border-l-2 border-white/20 pl-6 space-y-5">
                    <!-- Items dinámicos -->
                    </ol>
                </div>
                </div>
            </div>

            <script>
                // Utilidades UI
                const $ = (q) => document.querySelector(q);
                const panelEmpty = $("#history-empty");
                const panelResult = $("#history-result");
                const personName = $("#person-name");
                const personMeta = $("#person-meta");
                const personTags = $("#person-tags");
                const timeline = $("#timeline");

                // Mapa de íconos y etiquetas por tipo de evento
                const EVENT_META = {
                nacimiento:   { label: "Nació",                 icon: "cake" },
                union_pareja: { label: "Unión de pareja",       icon: "favorite" },
                tuvo_hijo:    { label: "Nacimiento de hijo/a",  icon: "child_care" },
                enviudo:      { label: "Enviudó",               icon: "link_off" },
                fallecimiento:{ label: "Falleció",              icon: "local_florist" },
                };

                // Render chips de resumen
                function renderTags(events) {
                personTags.innerHTML = "";
                const counts = events.reduce((acc, e) => {
                    acc[e.tipo] = (acc[e.tipo] || 0) + 1;
                    return acc;
                }, {});
                Object.entries(counts).forEach(([tipo, n]) => {
                    const meta = EVENT_META[tipo] || { label: tipo, icon: "event" };
                    const tag = document.createElement("span");
                    tag.className = "inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white/10 border border-white/20 text-sm";
                    tag.innerHTML = `<span class="material-icons text-[18px]">${meta.icon}</span>${meta.label}: ${n}`;
                    personTags.appendChild(tag);
                });
                }

                // Render línea de tiempo
                function renderTimeline(events) {
                // Ordena por año ascendente y luego por tipo
                events.sort((a, b) => {
                    const ax = parseInt(a.anio || 0, 10), bx = parseInt(b.anio || 0, 10);
                    if (ax !== bx) return ax - bx;
                    return (a.tipo || "").localeCompare(b.tipo || "");
                });

                timeline.innerHTML = "";
                events.forEach((ev, idx) => {
                    const meta = EVENT_META[ev.tipo] || { label: ev.tipo || "Evento", icon: "event" };
                    const item = document.createElement("li");
                    item.className = "relative pl-8";
                    item.innerHTML = `
                    <span class="absolute -left-[8px] top-1.5 w-4 h-4 rounded-full bg-[#01C38E] border-2 border-white"></span>
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex items-center gap-3">
                        <span class="material-icons text-[22px] text-[#01C38E]">${meta.icon}</span>
                        <div>
                            <div class="text-base font-medium">${meta.label}</div>
                            ${ev.detalle ? `<div class="text-sm text-gray-300">${ev.detalle}</div>` : ""}
                        </div>
                        </div>
                        <div class="text-right">
                        <span class="text-sm text-white/80 bg-white/10 border border-white/20 rounded-md px-2 py-0.5">${ev.anio || "—"}</span>
                        </div>
                    </div>
                    `;
                    timeline.appendChild(item);
                });
                }

                // Rellena la UI con los datos de una persona
                function renderPersonHistory(payload) {
                const { persona = {}, eventos = [] } = payload || {};
                const nombreCompleto = persona.nombre_completo || "—";
                const genero = persona.genero || "";
                const estado = persona.estado_civil || "";

                personName.textContent = nombreCompleto;
                personMeta.textContent = [genero, estado].filter(Boolean).join(" • ");

                renderTags(eventos);
                renderTimeline(eventos);

                panelEmpty.classList.add("hidden");
                panelResult.classList.remove("hidden");
                }

                // DEMO de respaldo si la API aún no existe
                function demoPayload(nombre) {
                // Pequeña heurística: genera algo plausible según el seed que tenés
                const now = new Date().getFullYear();
                return {
                    persona: {
                    nombre_completo: nombre,
                    genero: "—",
                    estado_civil: "",
                    },
                    eventos: [
                    { tipo: "nacimiento",   anio: now - 30,  detalle: "" },
                    { tipo: "union_pareja", anio: now - 6,   detalle: "Con su pareja actual" },
                    { tipo: "tuvo_hijo",    anio: now - 4,   detalle: "Primer hijo/a" },
                    { tipo: "tuvo_hijo",    anio: now - 1,   detalle: "Segundo hijo/a" },
                    ],
                };
                }

                // Buscar en backend
                async function fetchHistory(nombre) {
                // Endpoint sugerido (ajústalo en tu backend):
                // GET /api/history?nombre=Nombre%20Apellido
                try {
                    const res = await fetch(`/api/history?nombre=${encodeURIComponent(nombre)}`);
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    const data = await res.json();
                    if (!data || (!data.persona && !data.eventos)) throw new Error("payload inválido");
                    return data;
                } catch (e) {
                    console.warn("Usando DEMO (sin API aún):", e);
                    return demoPayload(nombre);
                }
                }

                // Submit del buscador
                document.getElementById("history-search").addEventListener("submit", async (e) => {
                e.preventDefault();
                const q = (document.getElementById("history-input").value || "").trim();
                if (!q) return;

                // Limpia y muestra estado
                panelResult.classList.add("hidden");
                panelEmpty.classList.remove("hidden");
                panelEmpty.textContent = "Buscando…";

                // Traer datos y renderizar
                const payload = await fetchHistory(q);
                renderPersonHistory(payload);
                });
            </script>
            </div>
      </div>
    </main>
  </div>
</body>
</html>
